# Task Report

## Task
- ID: GOAL-002/003/004
- Title: Weighted events + explainable signals + personalized guidance
- Timestamp: 20260214-143900

## English (For Agents)
### Plan
- Implement GOAL-002 in backend news impact service.
- Implement GOAL-003 event-driven explainable signal service and endpoint.
- Implement GOAL-004 personalized risk/position guidance service and endpoint.
- Run backend unit tests and update automation docs/states.

### Development Actions
- Updated `StockNewsImpactService`:
  - Added event type classification (`公告`/`研报`/`新闻`) with type weights.
  - Added source credibility weighting.
  - Added theme detection and same-theme deduplication merge.
- Updated `StockNewsImpactItemDto` with metadata fields (`EventType`, `TypeWeight`, `SourceCredibility`, `Theme`, `MergedCount`).
- Added `StockSignalService` and `IStockSignalService`:
  - Event-driven signal scoring (`EventImpactScore`, `TrendScore`, `AlignmentScore`).
  - Explainable output (`Evidence`, `CounterEvidence`, `Signals`, `Recommendation`, `Confidence`).
- Added `StockPositionGuidanceService` and `IStockPositionGuidanceService`:
  - Risk-profile based target position, drawdown limit, stop-loss/take-profit.
  - Action recommendation (`加仓`/`减仓`/`持有`).
- Added models in `StockDecisionDto.cs`.
- Added API endpoints in `StocksModule`:
  - `GET /api/stocks/signals`
  - `POST /api/stocks/position-guidance`
- Added/updated unit tests:
  - `StockNewsImpactServiceTests` (updated + dedupe case)
  - `StockSignalAndGuidanceTests` (new)
- Updated documentation and automation tracking:
  - `README.md`
  - `.automation/tasks.json`
  - `.automation/state.json`
  - `.github/copilot-instructions.md` (new secret-handling rule)

### Tests / Script Validation
1) Focused tests (impact + signal + guidance)
- Command: `dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj --filter "StockSignalAndGuidanceTests|StockNewsImpactServiceTests"`
- Result: Passed (4 tests)

2) Full backend unit tests
- Command: `dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj`
- Result: Passed (26 tests)

3) Frontend/Edge MCP
- Not required in this change set because no frontend code was modified.

### Issues
- None.

## 中文（给你看的）
### 规划
- 落地 GOAL-002：多源事件权重评估。
- 落地 GOAL-003：事件驱动可解释信号。
- 落地 GOAL-004：个性化风险与仓位建议。
- 执行后端测试并同步文档与任务状态。

### 开发动作
- 改造 `StockNewsImpactService`：
  - 增加事件类型识别（公告/研报/新闻）及类型权重。
  - 增加来源可信度权重。
  - 增加主题识别与同主题事件合并去重。
- 扩展 `StockNewsImpactItemDto` 字段：`EventType`、`TypeWeight`、`SourceCredibility`、`Theme`、`MergedCount`。
- 新增 `StockSignalService`：
  - 输出事件分/趋势分/历史对齐分。
  - 输出证据、反证、信号与建议，支持可解释性。
- 新增 `StockPositionGuidanceService`：
  - 按风险档位给出目标仓位、回撤约束、止损止盈与操作建议。
- 新增模型文件 `StockDecisionDto.cs`。
- 新增接口：
  - `GET /api/stocks/signals`
  - `POST /api/stocks/position-guidance`
- 新增/更新单测：
  - `StockNewsImpactServiceTests`
  - `StockSignalAndGuidanceTests`
- 同步更新：`README.md`、`.automation/tasks.json`、`.automation/state.json`、`.github/copilot-instructions.md`。

### 测试/脚本验证
1) 定向测试（impact + signal + guidance）
- 命令：`dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj --filter "StockSignalAndGuidanceTests|StockNewsImpactServiceTests"`
- 结果：通过（4 tests）

2) 后端全量单测
- 命令：`dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj`
- 结果：通过（26 tests）

3) 前端/Edge MCP
- 本次未修改前端代码，按规则无需执行。

### 问题
- 无。
