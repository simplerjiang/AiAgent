# MANUAL Report (20260214-161010)

## EN
### Task
Fix two chart-data issues:
1) daily K-line volume appears empty;
2) weekly/yearly K-line has too few points.

### Changes
- Updated `backend/SimplerJiangAiAgent.Api/Modules/Stocks/Services/TencentStockCrawler.cs`:
  - Added interval-aware lookback windows and request counts.
  - For `year`, now fetches enough monthly bars before yearly aggregation.
  - Returns `safeCount` bars after normalization/aggregation.
- Updated `frontend/src/modules/stocks/StockCharts.vue`:
  - Added robust volume parser (`parseVolumeValue`) for number/string/comma/万/亿 formats.
  - Reused parser for K-line and minute-volume data mapping.
  - Increased K-line volume histogram opacity for visibility.

### Validation
- Frontend unit tests:
  - `npm run test:unit` -> PASS (6 files, 23 tests).
- Backend unit tests:
  - `dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj` -> PASS (26 tests).
- Live API checks:
  - `GET /api/stocks/detail?symbol=sz000021&interval=day&count=60` -> `dayCount=60`, volume present.
  - `GET /api/stocks/detail?symbol=sz000021&interval=week&count=60` -> `weekCount=60`.
  - `GET /api/stocks/detail?symbol=sz000021&interval=year&count=60` -> `yearCount=33`.

### Notes
- The backend test initially failed due to a locked running API process; stopped process and reran successfully.

## ZH
### 任务
修复两个图表数据问题：
1）日K成交量显示为空；
2）周线/年线返回数据点过少。

### 修改内容
- 更新 `backend/SimplerJiangAiAgent.Api/Modules/Stocks/Services/TencentStockCrawler.cs`：
  - 增加按周期动态扩展回溯窗口与请求条数。
  - 对 `year` 周期先抓足够月线再做年线聚合。
  - 聚合后按 `safeCount` 返回结果。
- 更新 `frontend/src/modules/stocks/StockCharts.vue`：
  - 新增 `parseVolumeValue`，支持数字/字符串/逗号/万/亿单位解析。
  - K线与分时量柱统一用该解析逻辑。
  - 提高日K量柱颜色不透明度，增强可见性。

### 验证结果
- 前端单测：
  - `npm run test:unit` -> 通过（6 文件，23 测试）。
- 后端单测：
  - `dotnet test backend/SimplerJiangAiAgent.Api.Tests/SimplerJiangAiAgent.Api.Tests.csproj` -> 通过（26 测试）。
- 本地接口实测：
  - `interval=day,count=60` -> `dayCount=60` 且 volume 有值。
  - `interval=week,count=60` -> `weekCount=60`。
  - `interval=year,count=60` -> `yearCount=33`。

### 说明
- 后端测试首次失败原因为 API 进程占用文件，停止进程后重测通过。
